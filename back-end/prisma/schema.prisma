generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TrailDifficulty {
  EASY
  MODERATE
  HARD
}

enum TrailStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum TrailSessionStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  RESCHEDULED
}

enum BookingSource {
  PUBLIC_PORTAL
  ADMIN
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  ARCHIVED
}

enum EventRegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum FaunaFloraCategory {
  FAUNA
  FLORA
}

enum ConservationStatus {
  NOT_EVALUATED
  LEAST_CONCERN
  NEAR_THREATENED
  VULNERABLE
  ENDANGERED
  CRITICALLY_ENDANGERED
}

enum TipoUsuario {
  A
  C
  G
}

model Usuario {
  cpf             String      @id
  nome            String?
  sobrenome       String?
  email           String?     @unique
  senhaHash       String
  tipo            TipoUsuario
  dataNascimento  DateTime?
  cidadeOrigem    String?
  criadoEm        DateTime    @default(now())
  atualizadoEm    DateTime    @updatedAt
  guia            Guide?
  convitesCriados Convite[]   @relation("ConvitesCriados")

  @@map("usuarios")
}

model Convite {
  token        String      @id
  cpfConvidado String
  tipo         TipoUsuario
  criadoPorCpf String
  validoAte    DateTime
  utilizadoEm  DateTime?
  criadoEm     DateTime    @default(now())

  criadoPor Usuario @relation("ConvitesCriados", fields: [criadoPorCpf], references: [cpf], onDelete: Cascade)

  @@index([cpfConvidado])
  @@map("convites")
}

model Guide {
  cpf             String         @id
  usuario         Usuario        @relation(fields: [cpf], references: [cpf], onDelete: Cascade)
  slug            String         @unique
  name            String
  photoUrl        String?
  speciality      String?
  biography       String?
  summary         String?
  experienceYears Int            @default(0)
  rating          Float          @default(0)
  toursCompleted  Int            @default(0)
  languages       String[]       @default([])
  certifications  String[]       @default([])
  curiosities     String[]       @default([])
  featuredTrailId String?
  featuredTrail   Trail?         @relation("FeaturedGuideTrail", fields: [featuredTrailId], references: [id])
  isFeatured      Boolean        @default(false)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  trails          TrailGuide[]
  sessions        TrailSession[]
  bookings        Booking[]

  @@map("guias")
}

model Trail {
  id               String          @id @default(cuid())
  slug             String          @unique
  name             String
  description      String
  summary          String?
  durationMinutes  Int
  difficulty       TrailDifficulty
  maxGroupSize     Int
  badgeLabel       String?
  imageUrl         String?
  status           TrailStatus     @default(ACTIVE)
  basePrice        Decimal?        @db.Decimal(10, 2)
  highlight        Boolean         @default(false)
  meetingPoint     String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  guides           TrailGuide[]
  sessions         TrailSession[]
  bookings         Booking[]
  featuredInGuides Guide[]         @relation("FeaturedGuideTrail")
  activityLogs     ActivityLog[]

  @@map("trilhas")
}

model TrailGuide {
  trailId  String
  guideCpf String
  assigned DateTime @default(now())

  trail Trail @relation(fields: [trailId], references: [id], onDelete: Cascade)
  guide Guide @relation(fields: [guideCpf], references: [cpf], onDelete: Cascade)

  @@id([trailId, guideCpf])
  @@map("trilhas_guias")
}

model TrailSession {
  id              String             @id @default(cuid())
  trailId         String
  primaryGuideCpf String?
  startsAt        DateTime
  endsAt          DateTime?
  capacity        Int
  meetingPoint    String?
  notes           String?
  status          TrailSessionStatus @default(SCHEDULED)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  trail        Trail     @relation(fields: [trailId], references: [id])
  primaryGuide Guide?    @relation(fields: [primaryGuideCpf], references: [cpf])
  bookings     Booking[]

  @@map("sessoes_trilhas")
}

model Booking {
  id                String        @id @default(cuid())
  protocol          String        @unique
  trailId           String
  sessionId         String?
  guideCpf          String?
  status            BookingStatus @default(PENDING)
  scheduledFor      DateTime
  participantsCount Int           @default(1)
  contactName       String
  contactEmail      String
  contactPhone      String
  notes             String?
  source            BookingSource @default(PUBLIC_PORTAL)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  trail        Trail         @relation(fields: [trailId], references: [id])
  session      TrailSession? @relation(fields: [sessionId], references: [id])
  guide        Guide?        @relation(fields: [guideCpf], references: [cpf])
  participants Participant[]
  activityLogs ActivityLog[]

  @@map("agendamentos")
}

model Participant {
  id               String    @id @default(cuid())
  bookingId        String
  fullName         String
  cpf              String?
  email            String?
  phone            String?
  birthDate        DateTime?
  emergencyContact String?
  isBanned         Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("participantes")
}

model Event {
  id          String      @id @default(cuid())
  slug        String      @unique
  title       String
  description String
  location    String?
  startsAt    DateTime
  endsAt      DateTime?
  capacity    Int?
  status      EventStatus @default(DRAFT)
  highlight   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  registrations EventRegistration[]
  activityLogs  ActivityLog[]

  @@map("eventos")
}

model EventRegistration {
  id        String                  @id @default(cuid())
  eventId   String
  fullName  String
  email     String
  phone     String?
  status    EventRegistrationStatus @default(PENDING)
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("inscricoes_eventos")
}

model FaunaFloraRecord {
  id             String             @id @default(cuid())
  slug           String             @unique
  name           String
  scientificName String
  category       FaunaFloraCategory
  status         ConservationStatus
  description    String?
  imageUrl       String?
  tags           String[]           @default([])
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@map("registros_fauna_flora")
}

model ActivityLog {
  id        String   @id @default(cuid())
  bookingId String?
  eventId   String?
  trailId   String?
  message   String
  loggedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  createdBy String?

  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  event   Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)
  trail   Trail?   @relation(fields: [trailId], references: [id], onDelete: SetNull)

  @@index([loggedAt])
  @@map("registros_atividade")
}
